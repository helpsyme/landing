<!-- file:///Volumes/DEV/GIT/landing/form/doc.html?token=TEST-TOKEN-001&utm_source=google&utm_medium=cpc&utm_campaign=promo_oct&utm_term=спина&utm_content=banner_1 -->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>Персональна пропозиція та Запис</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>

<style>
  /* ===== Стили остаются те же ===== */
  :root {
    --color-background-start: #ecedf3; 
    --color-background-end: #d8d8e5;   
    --color-card: #ffffff;
    --color-text-main: #2c2c2e;
    --color-text-subtle: #8e8e93; 
    --color-accent-blue: #007aff; 
    --color-focus-shadow: rgba(0, 122, 255, 0.2); 
    --color-success: #34c759;
    --color-border-light: #c8c8d3;
    --color-shadow: rgba(0, 0, 0, 0.08);
    --color-button-inactive: #f7f7f9;
    --color-button-inactive-border: #e0e0e5;
    --color-price-gradient-start: #e1e9ff; 
    --color-price-gradient-end: #f5f8ff;   
    --color-price-old-subtle: #9999a0;
    --color-price-new-bold: #c70039; 
    --color-price-block-shadow: rgba(0, 122, 255, 0.25); 
  }

  body {
    background: 
      repeating-linear-gradient(-45deg, rgba(0,0,0,0.05), rgba(0,0,0,0.05) 1px, transparent 1px, transparent 20px),
      linear-gradient(150deg, var(--color-background-start) 0%, var(--color-background-end) 100%);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    color: var(--color-text-main);
    line-height: 1.6;
    padding: 30px;
  }

  .container { padding-top: 20px; padding-bottom: 20px; }
  h1 { font-weight: 700; color: var(--color-text-main); text-align: center; margin-bottom: 35px; font-size: 2.2rem; text-shadow: 0 1px 0 rgba(255,255,255,0.7); }
  label { font-weight: 600; color: var(--color-text-main); margin-bottom: 6px; font-size: 0.95rem; }
  form { background-color: var(--color-card); border-radius: 28px; padding: 35px; box-shadow: 0 10px 30px var(--color-shadow); border: 1px solid var(--color-border-light); }
  .doctor-card { text-align: center; margin-bottom: 30px; }
  .doctor-card img { width: 140px; height: 140px; object-fit: cover; border-radius: 50%; margin-bottom: 15px; border: 4px solid var(--color-accent-blue); box-shadow: 0 4px 10px var(--color-shadow); }
  .form-control[disabled] { background-color: transparent; color: var(--color-text-main); font-weight: 700; border: none; text-align: center; padding: 0; font-size: 1.2rem; }

  .price-block { max-width: 500px; margin: 0 auto; background: linear-gradient(135deg, var(--color-price-gradient-start), var(--color-price-gradient-end)); border-radius: 28px; padding: 35px 30px; margin-bottom: 40px; box-shadow: 0 15px 35px var(--color-price-block-shadow); border: 1px solid #a8c4ff; transition: all 0.3s ease-in-out; }
  .price-block .price-label { font-size: 0.95rem; color: var(--color-accent-blue); font-weight: 800; text-transform: uppercase; letter-spacing:1px; margin-bottom:18px; }
  .price-block .price-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 20px; }
  .price-block .price-new { font-weight:900; color: var(--color-price-new-bold); font-size:3.5rem; line-height:1; }
  .price-block .price-old { text-decoration: line-through; color: var(--color-price-old-subtle); font-size:1.5rem; margin-top:10px; }
  .price-block .promo-info { margin-top:20px; padding-top:18px; border-top:1px dashed #b0c2e3; font-size:1rem; color:var(--color-text-subtle); }
  .price-block .promo-info span { font-weight:700; color:var(--color-text-main); }

  .form-control { border-radius: 12px; border: 1px solid var(--color-border-light); padding:12px 18px; font-size:1rem; background-color:var(--color-button-inactive); }
  .form-control:focus { border-color:var(--color-accent-blue); box-shadow: 0 0 0 3px var(--color-focus-shadow); background-color:var(--color-card); }

  .btn-outline-primary, .btn-outline-success { border-radius: 20px; font-weight:500; padding:8px 16px; transition: all 0.2s; border:1px solid var(--color-button-inactive-border); color: var(--color-text-main); background-color: var(--color-button-inactive); }
  .btn-outline-primary.active, .btn-outline-success.active { color:#fff!important; background-color:var(--color-accent-blue)!important; border-color:var(--color-accent-blue)!important; box-shadow: 0 2px 5px rgba(0,122,255,0.3); }
  .btn-primary { border-radius:16px; font-weight:600; background-color:var(--color-accent-blue); border-color:var(--color-accent-blue); padding:14px 20px; font-size:1.05rem; box-shadow:0 5px 15px rgba(0,122,255,0.25); }
  .btn-primary:hover { background-color:#0066cc; border-color:#0066cc; box-shadow:0 8px 18px rgba(0,122,255,0.35); }

  .date-card { border:1px solid var(--color-border-light); border-radius:16px; overflow:hidden; margin-bottom:10px; }
  .card-header { background-color:var(--color-card); border-bottom:none; font-weight:600; color:var(--color-text-main); padding:14px 20px !important; }
  .toggle-icon { font-size:1.2rem; font-weight:700; transition: transform 0.3s; }
  .card-header[aria-expanded="true"] .toggle-icon { transform: rotate(90deg); }
  .card-body { border-top:1px solid var(--color-button-inactive-border); background-color:var(--color-button-inactive); padding:15px 20px; }
  #toast-container { z-index: 10800; }

  /* Оверлей со спиннером */
  #loadingOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.9);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  #loadingOverlay.hidden { display: none; }

  .discount-highlight {
    font-size: 2.5rem;        /* большой размер */
    font-weight: 900;         /* жирный шрифт */
    color: #c70039;           /* ярко-красный */
    text-shadow: 0 0 10px rgba(199,0,57,0.6); /* легкая подсветка */
    animation: pulse 1.5s infinite; /* пульсация */
    display: inline-block;
    margin: 0 10px;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }
</style>
</head>
<body class="p-4">

<div class="container">
  <h1>Персональна пропозиція та Запис</h1>

  <form id="bookingForm" autocomplete="off" novalidate>
    <div class="doctor-card">
      <img id="doctorPhoto" src="" alt="Лікар">
      <input type="text" id="doctorName" class="form-control" value="" disabled>
    </div>

    <div class="mb-4 price-block text-center">
      <div class="price-label">Ваша персональна пропозиція</div>
      <div class="price-wrapper">
        <div class="price-new"></div>
        <div class="price-old"></div>
      </div>
      <div class="price-note">
        Знижка 
        <span id="discount" class="discount-highlight"></span> активна лише для вас!
      </div>
    </div>

    <!-- Форма -->
    <div class="mb-4"><label for="name" class="form-label">Ім'я</label><input type="text" class="form-control" id="name" required></div>
    <div class="mb-4"><label for="surname" class="form-label">Прізвище</label><input type="text" class="form-control" id="surname" required></div>
    <div class="mb-4"><label for="patronymic" class="form-label">По батькові (необов'язково)</label><input type="text" class="form-control" id="patronymic"></div>
    <div class="mb-4"><label for="birthdate" class="form-label">Дата народження</label><input type="text" class="form-control" id="birthdate" placeholder="дд.мм.рррр" required></div>
    <div class="mb-4"><label for="phone" class="form-label">Телефон</label><input type="tel" class="form-control" id="phone" required></div>
    <div class="mb-4"><label for="email" class="form-label">Email</label><input type="email" class="form-control" id="email" required></div>

    <div class="mb-4"><label class="form-label">Ваше основне питання</label><div id="problemButtons" class="d-flex flex-wrap gap-2"></div><input type="hidden" id="problem"></div>

    <div class="mb-4"><label class="form-label">Вибір дати та часу</label><div id="datesSlots"></div><input type="hidden" id="selectedSlot"><input type="hidden" id="selectedDate"></div>

    <div class="mb-4"><label for="additionalInfo" class="form-label">Коментар</label><textarea class="form-control" id="additionalInfo" rows="3"></textarea></div>
    
    <input type="text" class="form-control" id="docID" hidden>
    <input type="text" class="form-control" id="clientID" hidden>
    <input type="text" class="form-control" id="priceOld" hidden>
    <input type="text" class="form-control" id="priceNew" hidden>
    <input type="text" class="form-control" id="discountPercent" hidden>

    <div class="d-flex justify-content-center"><button type="submit" class="btn btn-primary w-50">Записатися</button></div>
  </form>
</div>
<!-- СПИННЕР ПРИ ЗАГРУЗКЕ -->
<div id="loadingOverlay">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Завантаження...</span>
  </div>
  <div class="mt-3 text-primary fw-bold">Завантаження...</div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.9/jquery.inputmask.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
$(function() {

  // --- Параметры ---
  const requiredKeys = ['token']; // обязательные
  const optionalKeys = ['utm_source','utm_medium','utm_campaign','utm_term']; // необязательные

  // --- Маски ---
  Inputmask({ mask: "99.99.9999" }).mask($('#birthdate'));
  Inputmask({ mask: "+38(999)999-99-99" }).mask($('#phone'));
  Inputmask({ alias: "email" }).mask($('#email'));

  // --- Проблемы ---
  const problems = ['Депресія','Тривожно-фобiчнi розлади','ОКР','Розлади харчування','Інше'];
  const problemContainer = $('#problemButtons');
  problems.forEach(p => {
    const btn = $(`<button type="button" class="btn btn-outline-primary btn-sm">${p}</button>`);
    btn.on('click', function() {
      $('#problem').val(p);
      problemContainer.find('button').removeClass('active');
      $(this).addClass('active');
    });
    problemContainer.append(btn);
  });

  // --- Получение URL параметров ---
  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    const result = {};
    const missingKeys = [];

    // Проверяем обязательные ключи
    requiredKeys.forEach(k => {
      const value = params.get(k);
      if (!value) missingKeys.push(k);
      result[k] = value || '';
    });

    // Проверяем необязательные ключи
    optionalKeys.forEach(k => {
      result[k] = params.get(k) || '';
    });

    // Если не хватает обязательных параметров — показываем сообщение
    if (missingKeys.length) {
      $('body').children().not('#loadingOverlay').hide();
      $('body').append(`
        <div class="container mt-5 text-center">
          <h2>На жаль, персональна пропозиція недоступна</h2>
        </div>
      `);
      // Можно вернуть null, чтобы другие части кода знали, что параметры невалидные
      return null;
    }

    return result;
  }

  let urlParams;
  try {
    urlParams = getUrlParams();
    console.log('URL params:', urlParams);
  } catch(err) {
    $('#loadingOverlay').addClass('hidden');
    toastr.error(err.message);
    return; // останавливаем дальнейшую загрузку
  }

// --- Запрос к API для заполнения страницы ---
$('#loadingOverlay').removeClass('hidden');

// --- Запрос к API для заполнения страницы ---
$('#loadingOverlay').removeClass('hidden');

// --- Запрос к API для заполнения страницы ---
$('#loadingOverlay').removeClass('hidden');

fetch("https://script.google.com/macros/s/AKfycby2biLXh3zPNFudnQYdvsOeMQZzZJ_9QQdLzuQsyWcGILydK7Oajry6EmXleqJf0pfGIg/exec", {
  method: 'POST',
  headers: { 'Content-Type': 'text/plain;charset=utf-8' },
  body: JSON.stringify({ init: 1, ...urlParams })
})
.then(r => r.json())
.then(resp => {
  $('#loadingOverlay').addClass('hidden');
  console.log("data:", resp);



  const page = resp;
  // --- Если статус внутри данных не success ---
  if (!page || page.status !== 'success') {
    $('body').children().not('#loadingOverlay').hide();
    $('body').append(`
      <div class="container mt-5 text-center">
        <h2>На жаль, персональна пропозиція недоступна</h2>
      </div>
    `);
    return;
  }

  // --- Если success, заполняем страницу ---
  if(page.doctorName) $('#doctorName').val(page.doctorName);
  if(page.doctorPhoto) $('#doctorPhoto').attr('src', page.doctorPhoto);
  if(page.priceNew) $('.price-new').text(page.priceNew);
  if(page.priceOld) $('.price-old').text(page.priceOld);
  if(page.clientID) $('#clientID').val(page.clientID);
  if(page.docID) $('#docID').val(page.docID);
  
  
  if (page.discountPercent) {
      $('#discount').text(`${page.discountPercent}%`);
    }

  if (page.priceNew) $('#priceNew').val(page.priceNew);
  if (page.priceOld) $('#priceOld').val(page.priceOld);
  if (page.discountPercent) $('#discountPercent').val(page.discountPercent);
  
  // проверяем
  console.log('docID =', $('#docID').val());
  console.log('clientID =', $('#clientID').val());
  console.log('priceNew =', $('#priceNew').val());
  console.log('priceOld =', $('#priceOld').val());
  console.log('discountPercent =', $('#discountPercent').val());
  
  if(page.dates && page.dates.length) {
    const datesContainer = $('#datesSlots').empty();
    page.dates.forEach(d => {
      const collapseId = 'collapse_' + d.date.replace(/-/g,'');
      const card = $(`
        <div class="card mb-2 date-card">
          <div class="card-header d-flex justify-content-between align-items-center" 
              data-bs-toggle="collapse" data-bs-target="#${collapseId}">
            <span>${d.date}</span><span class="toggle-icon">▸</span>
          </div>
          <div id="${collapseId}" class="collapse">
            <div class="card-body d-flex flex-wrap gap-2"></div>
          </div>
        </div>
      `);
      d.slots.forEach(slot => {
        const btn = $(`<button type="button" class="btn btn-outline-success btn-sm">${slot}</button>`);
        btn.on('click', function() {
          $('.date-card .card-body button').removeClass('active');
          $('#selectedDate').val(d.date);
          $('#selectedSlot').val(slot);
          $(this).addClass('active');
        });
        card.find('.card-body').append(btn);
      });
      datesContainer.append(card);
    });
  } else {
    // Если нет слотов
    $('body').children().not('#loadingOverlay').hide();
    $('body').append(`
      <div class="container mt-5 text-center">
        <h2>На жаль, персональна пропозиція недоступна</h2>
        <p>Вільних слотів немає</p>
      </div>
    `);
  }
})
.catch(e => {
  $('#loadingOverlay').addClass('hidden');
  $('body').children().not('#loadingOverlay').hide();
  $('body').append(`
    <div class="container mt-5 text-center">
      <h2>На жаль, персональна пропозиція недоступна</h2>
      <p>Не вдалося завантажити дані</p>
    </div>
  `);
  console.error(e);
});

// --- Функция для парсинга UTM из URL ---
function getUTMParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    utm_source: params.get('utm_source') || "",
    utm_medium: params.get('utm_medium') || "",
    utm_campaign: params.get('utm_campaign') || "",
    utm_term: params.get('utm_term') || "",
    utm_content: params.get('utm_content') || ""
  };
}

// --- Сабмит формы ---
$('#bookingForm').on('submit', function(e) {
  e.preventDefault();

  const btn = $(this).find('button[type=submit]');
  const oldText = btn.html();
  btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Відправка...');

  // Собираем данные формы
  const formData = {
    first_name: $('#name').val(),
    last_name: $('#surname').val(),
    middle_name: $('#patronymic').val(),
    birthdate: $('#birthdate').val(),
    phone: $('#phone').val(),
    email: $('#email').val(),
    problem: $('#problem').val(),
    doctor: $('#doctorName').val(),
    docid: $('#docID').val(),
    date: $('#selectedDate').val(),
    slot: $('#selectedSlot').val(),
    priceold: $('#priceOld').val(),
    pricenew: $('#priceNew').val(),
    discountpercent: $('#discountPercent').val(),
    token: urlParams.token || "",
    clientid: $('#clientID').val(),
  };
  console.log("formData:" + formData);
  // Добавляем UTM-метки
  const utmData = getUTMParams();

  // Формируем итоговый payload
  const payload = { ...formData, ...utmData };

  fetch('https://script.google.com/macros/s/AKfycbzdYVR7l79ww1w2v2IygQT4kqbMGIOdPhSDOxbIXEyOYYa52mD2T2qedisemirooLyanQ/exec', {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === 'success') {
      toastr.success("Форма успішно відправлена!");
      $('#bookingForm')[0].reset();
      $('.btn-outline-primary, .btn-outline-success').removeClass('active');
      window.location.href = "/form-end"; // редирект только при успехе
    } else if (res.status === 'error' && res.message.includes('цей час вже зайнятий')) {
      // слот занят
      toastr.error(res.message);
    } else {
      toastr.error(res.message || "Помилка при обробці заявки");
    }
  })
  .catch(() => {
    toastr.error("Не вдалося відправити заявку");
  })
  .finally(() => {
    btn.prop('disabled', false).html(oldText);
  });
});

});
</script>
</body>
</html>
